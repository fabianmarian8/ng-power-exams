name: Bootstrap Yarn Zero-Install

on:
  workflow_dispatch:

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # aby mohol commitnuť .yarn/cache + yarn.lock

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - name: Pin Yarn 3.6.4
        run: |
          yarn set version 3.6.4
          yarn --version

      # DÔLEŽITÉ: prvý bootstrap musí dočasne vypnúť "immutable",
      # inak sa yarn.lock a .yarn/cache nevytvoria.
      - name: Allow lockfile & cache creation (disable immutable)
        run: yarn config set enableImmutableInstalls false

      - name: Configure linker & registry (stable)
        run: |
          yarn config set nodeLinker node-modules
          yarn config set npmRegistryServer https://registry.npmjs.org

      - name: Install (ONLINE) to populate .yarn/cache
        run: yarn install

      - name: Show cache stats
        run: |
          ls -lah .yarn || true
          ls -lah .yarn/cache || true

      - name: Commit Yarn artifacts
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git add .yarn .yarnrc.yml yarn.lock package.json
          git commit -m "chore: bootstrap Yarn Zero-Install (cache + lockfile)" || echo "no changes"
          git push || echo "push failed (protected branch?)"

      # Ak je main chránený a push z Actions je blokovaný, otvor PR:
      - name: Create PR if push blocked
        if: ${{ failure() || cancelled() }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/yarn-cache
          title: "Bootstrap Yarn Zero-Install"
          commit-message: "chore: bootstrap Yarn Zero-Install (cache + lockfile)"
          body: |
            This PR adds `.yarn/cache`, `yarn.lock` and pins Yarn 3.6.4.
            Merge to enable offline installs in other workflows.
